{"version":3,"sources":["turbopack:///[project]/Desktop/drivewise/web/lib/subscriptions.ts"],"sourcesContent":["import type { LicenseCategory } from '@/types/database';\r\n\r\n// Plan identifiers\r\nexport type PlanTier = 'FREE' | 'PLAN_A' | 'PLAN_B' | 'PLAN_C';\r\n\r\nexport type PaidPlanTier = Exclude<PlanTier, 'FREE'>;\r\n\r\nexport interface PlanDefinition {\r\n  id: PaidPlanTier;\r\n  label: string;\r\n  months: number;\r\n  priceEur: number;\r\n  // derived convenience fields\r\n  pricePerMonthEur: number;\r\n  badge?: 'MOST_POPULAR' | 'BEST_VALUE';\r\n  emphasize?: boolean;\r\n}\r\n\r\nexport interface BillingConfig {\r\n  freeTestLimitPerCategory: number;\r\n  paidTestLimitPerCategory: number;\r\n  billingCycleDays: number;\r\n  bestValuePlan: PaidPlanTier;\r\n  plans: Record<PaidPlanTier, PlanDefinition>;\r\n}\r\n\r\n// Centralized billing / pricing configuration.\r\n// Values can be overridden via NEXT_PUBLIC_* env vars without changing code.\r\nconst freeLimit = Number(process.env.NEXT_PUBLIC_FREE_TEST_LIMIT_PER_CATEGORY ?? '3');\r\nconst paidLimit = Number(process.env.NEXT_PUBLIC_PAID_TEST_LIMIT_PER_CATEGORY ?? '9999');\r\nconst cycleDays = Number(process.env.NEXT_PUBLIC_BILLING_CYCLE_DAYS ?? '30');\r\nconst bestValueEnv = process.env.NEXT_PUBLIC_PAYMENT_BEST_VALUE_PLAN as PaidPlanTier | undefined;\r\n\r\nconst rawPlans: Omit<PlanDefinition, 'pricePerMonthEur'>[] = [\r\n  {\r\n    id: 'PLAN_A',\r\n    label: '1 month',\r\n    months: 1,\r\n    priceEur: 3,\r\n  },\r\n  {\r\n    id: 'PLAN_B',\r\n    label: '2 months',\r\n    months: 2,\r\n    priceEur: 6,\r\n  },\r\n  {\r\n    id: 'PLAN_C',\r\n    label: '3 months',\r\n    months: 3,\r\n    priceEur: 8,\r\n    badge: 'BEST_VALUE',\r\n    emphasize: true,\r\n  },\r\n];\r\n\r\nconst plansRecord = rawPlans.reduce<Record<PaidPlanTier, PlanDefinition>>((acc, plan) => {\r\n  const pricePerMonthEur = plan.priceEur / plan.months;\r\n  acc[plan.id] = { ...plan, pricePerMonthEur };\r\n  return acc;\r\n}, {} as Record<PaidPlanTier, PlanDefinition>);\r\n\r\nexport const BILLING_CONFIG: BillingConfig = {\r\n  freeTestLimitPerCategory: freeLimit,\r\n  paidTestLimitPerCategory: paidLimit,\r\n  billingCycleDays: cycleDays,\r\n  bestValuePlan: bestValueEnv ?? 'PLAN_C',\r\n  plans: plansRecord,\r\n};\r\n\r\nexport interface CategoryPlan {\r\n  id: string;\r\n  userId: string;\r\n  category: LicenseCategory;\r\n  planTier: PaidPlanTier;\r\n  startDate: string; // ISO\r\n  endDate: string;   // ISO\r\n  isActive: boolean;\r\n  createdAt: string; // ISO\r\n}\r\n\r\nexport interface Entitlements {\r\n  canAccessTests: boolean;\r\n  canStartNewTest: boolean;\r\n  remainingFreeTests?: number;\r\n  canAccessDecisionTrainer: boolean;\r\n  canAccessStudyMaterial: boolean;\r\n  canReviewTestsInDetail: boolean;\r\n}\r\n\r\nexport interface EntitlementInput {\r\n  isAdmin: boolean;\r\n  testsTakenThisCycle: number;\r\n  activePlan?: Pick<CategoryPlan, 'planTier' | 'startDate' | 'endDate' | 'isActive'> | null;\r\n  now?: Date;\r\n}\r\n\r\nexport function isPlanCurrentlyActive(plan?: { startDate: string; endDate: string } | null, now: Date = new Date()): boolean {\r\n  if (!plan) return false;\r\n  const start = new Date(plan.startDate).getTime();\r\n  const end = new Date(plan.endDate).getTime();\r\n  const ts = now.getTime();\r\n  return ts >= start && ts <= end;\r\n}\r\n\r\nexport function computeEntitlements(input: EntitlementInput): Entitlements {\r\n  const { isAdmin, testsTakenThisCycle, activePlan, now } = input;\r\n\r\n  if (isAdmin) {\r\n    return {\r\n      canAccessTests: true,\r\n      canStartNewTest: true,\r\n      remainingFreeTests: undefined,\r\n      canAccessDecisionTrainer: true,\r\n      canAccessStudyMaterial: true,\r\n      canReviewTestsInDetail: true,\r\n    };\r\n  }\r\n\r\n  const hasActivePaidPlan = !!activePlan && isPlanCurrentlyActive(\r\n    { startDate: activePlan.startDate, endDate: activePlan.endDate },\r\n    now,\r\n  );\r\n\r\n  if (hasActivePaidPlan) {\r\n    return {\r\n      canAccessTests: true,\r\n      canStartNewTest: testsTakenThisCycle < BILLING_CONFIG.paidTestLimitPerCategory,\r\n      remainingFreeTests: Math.max(\r\n        0,\r\n        BILLING_CONFIG.paidTestLimitPerCategory - testsTakenThisCycle,\r\n      ),\r\n      canAccessDecisionTrainer: true,\r\n      canAccessStudyMaterial: true,\r\n      canReviewTestsInDetail: true,\r\n    };\r\n  }\r\n\r\n  const remainingFree = Math.max(0, BILLING_CONFIG.freeTestLimitPerCategory - testsTakenThisCycle);\r\n\r\n  return {\r\n    canAccessTests: true,\r\n    canStartNewTest: remainingFree > 0,\r\n    remainingFreeTests: remainingFree,\r\n    canAccessDecisionTrainer: false,\r\n    canAccessStudyMaterial: false,\r\n    canReviewTestsInDetail: false,\r\n  };\r\n}\r\n\r\nexport interface CycleUsageInput {\r\n  attempts: { category: string; completed_at: string }[];\r\n  category: LicenseCategory;\r\n  now?: Date;\r\n}\r\n\r\nexport function countTestsInCurrentCycle(input: CycleUsageInput): number {\r\n  const { attempts, category, now } = input;\r\n  const current = now ?? new Date();\r\n  const cycleStart = new Date(current);\r\n  cycleStart.setDate(cycleStart.getDate() - BILLING_CONFIG.billingCycleDays + 1);\r\n  const startTs = cycleStart.getTime();\r\n  const endTs = current.getTime();\r\n\r\n  return attempts.filter((a) => {\r\n    if (a.category !== category) return false;\r\n    const ts = new Date(a.completed_at).getTime();\r\n    return ts >= startTs && ts <= endTs;\r\n  }).length;\r\n}\r\n"],"names":[],"mappings":"s3BA4BA,IAAM,EAAY,OAAO,QAAQ,GAAG,CAAC,wCAAwC,EAAI,KAC3E,EAAY,OAAO,QAAQ,GAAG,CAAC,wCAAwC,EAAI,QAC3E,EAAY,OAAO,QAAQ,GAAG,CAAC,8BAA8B,EAAI,MACjE,EAAe,QAAQ,GAAG,CAAC,mCAAmC,CAyB9D,EAvBuD,AAuBzC,CAtBlB,CACE,GAAI,SACJ,MAAO,UACP,OAAQ,EACR,SAAU,CACZ,EACA,CACE,GAAI,SACJ,MAAO,WACP,OAAQ,EACR,SAAU,CACZ,EACA,CACE,GAAI,SACJ,MAAO,WACP,OAAQ,EACR,SAAU,EACV,MAAO,aACP,WAAW,CACb,EACD,CAE4B,MAAM,CAAuC,CAAC,EAAK,KAC9E,IAAM,EAAmB,EAAK,QAAQ,CAAG,EAAK,MAAM,CAEpD,OADA,CAAG,CAAC,EAAK,EAAE,CAAC,CAAG,CAAE,GAAG,CAAI,kBAAE,CAAiB,EACpC,CACT,EAAG,CAAC,2BAEyC,CAC3C,yBAA0B,EAC1B,yBAA0B,EAC1B,iBAAkB,EAClB,cAAe,GAAgB,SAC/B,MAAO,CACT"}