module.exports=[54799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},73651,e=>{"use strict";var t=e.i(39883),r=e.i(94325),a=e.i(79987),s=e.i(89182),n=e.i(3358),i=e.i(51776),o=e.i(1631),l=e.i(47090),d=e.i(60242),u=e.i(56535),c=e.i(53383),p=e.i(27197),h=e.i(60623),_=e.i(27896),f=e.i(93144),m=e.i(55786),R=e.i(93695);e.i(88327);var g=e.i(17813),E=e.i(15173),v=e.i(54799),S=e.i(94132),w=e.i(72190);async function y(e){return E.NextResponse.json({status:"online",env_check:{PADDLE_WEBHOOK_SECRET:!!process.env.PADDLE_WEBHOOK_SECRET,NEXT_PUBLIC_SUPABASE_URL:!0,SUPABASE_SERVICE_ROLE_KEY:!!process.env.SUPABASE_SERVICE_ROLE_KEY}})}async function N(e){try{let t=e.headers.get("paddle-signature"),r=await e.text(),a=process.env.PADDLE_WEBHOOK_SECRET;if(!a)return E.NextResponse.json({error:"Server misconfiguration"},{status:500});if(!t)return E.NextResponse.json({error:"Missing signature"},{status:401});let s=t.split(";"),n=s.find(e=>e.startsWith("ts=")),i=s.find(e=>e.startsWith("h1="));if(!n||!i)return E.NextResponse.json({error:"Invalid signature format"},{status:401});let o=n.split("=")[1],l=i.split("=")[1],d=`${o}:${r}`;if(v.createHmac("sha256",a).update(d).digest("hex")!==l)return E.NextResponse.json({error:"Invalid signature"},{status:401});let u=JSON.parse(r),c=u.event_type;if("transaction.completed"===c){let e=u.data;e.custom_data;let t=e.custom_data||{};if("string"==typeof t)try{t=JSON.parse(t)}catch(e){t={}}if(0===Object.keys(t).length&&e.items&&e.items[0]?.custom_data&&(t=e.items[0].custom_data,"string"==typeof t))try{t=JSON.parse(t)}catch(e){t={}}if(0===Object.keys(t).length&&e.customer?.custom_data&&(t=e.customer.custom_data,"string"==typeof t))try{t=JSON.parse(t)}catch(e){t={}}if(0===Object.keys(t).length&&e.passthrough&&(t=e.passthrough,"string"==typeof t))try{t=JSON.parse(t)}catch(e){t={}}if(t&&t.custom_data&&"string"==typeof t.custom_data)try{let e=JSON.parse(t.custom_data);t={...t,...e}}catch(e){}let r=e.customer?.email||t.guest_email||t.email,a=e=>{if(!t)return;if(t[e])return t[e];if(t.custom_data&&t.custom_data[e])return t.custom_data[e];let r=e.charAt(0).toUpperCase()+e.slice(1);return t[r]?t[r]:t.custom_data&&t.custom_data[r]?t.custom_data[r]:void 0},s=a("category"),n=a("plan")||a("plan_tier"),i=a("user_id")||a("userId");e.id;let o=e.currency_code||"EUR",l=e.details?.totals?.grand_total;if(!l&&e.items&&e.items.length>0){let t=e.items[0];t.price&&t.price.unit_price&&(l=t.price.unit_price.amount)}l=l||"0";let d=Math.round(100*parseFloat(l)),c=e.subscription_id;if(!i&&!r)return E.NextResponse.json({received:!0});s?(s=s.toString().trim().toUpperCase(),["A","B","C","D"].includes(s)):s="UNKNOWN";let p=null;if(n){let e=n.toString().toUpperCase();["PLAN_A","PLAN_B","PLAN_C"].includes(e)&&(p=e)}p||(p=d>=250&&d<=400?"PLAN_A":d>=450&&d<=650?"PLAN_B":d>=750&&d<=950?"PLAN_C":"PLAN_A");try{let e=function(){let e="https://qtlnhgjgfwmohpnvikdm.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Supabase URL or Service Role Key is missing.");return(0,S.createClient)(e,t,{auth:{autoRefreshToken:!1,persistSession:!1}})}(),t=i,a=r;if(!t&&r){let{data:a,error:s}=await e.from("user_profiles").select("id").eq("email",r).single();if(s||!a){let{data:a,error:s}=await e.auth.admin.listUsers(),n=a?.users.find(e=>e.email===r);if(!n)return E.NextResponse.json({received:!0});t=n.id,await e.from("user_profiles").insert({id:n.id,email:r,full_name:r.split("@")[0],updated_at:new Date().toISOString()})}else t=a.id}if(!t)return E.NextResponse.json({received:!0});let{data:n}=await e.from("user_profiles").select("id").eq("id",t).single();if(!n){if(!a){let{data:r}=await e.auth.admin.getUserById(t);a=r.user?.email||`unknown_${t}@example.com`}let{error:r}=await e.from("user_profiles").insert({id:t,email:a,full_name:"Valued Customer",updated_at:new Date().toISOString()});if(r)return E.NextResponse.json({received:!0})}c&&await e.from("user_profiles").update({subscription_id:c,updated_at:new Date().toISOString()}).eq("id",t);let{data:l,error:h}=await e.from("orders").insert({user_id:t,category:s,plan_tier:p,amount_cents:d,currency:o,status:"paid",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(h);else{let{error:t}=await e.from("payment_transactions").insert({order_id:l.id,provider:"paddle",provider_status:"completed",amount_cents:d,currency:o,raw_payload:u,created_at:new Date().toISOString(),updated_at:new Date().toISOString()})}let _=w.BILLING_CONFIG.plans[p],f=new Date,m=new Date(f),R=new Date(f);R.setMonth(R.getMonth()+_.months);let{error:g}=await e.from("user_plans").upsert({user_id:t,category:s,plan_tier:p,start_date:m.toISOString(),end_date:R.toISOString(),status:"active",updated_at:f.toISOString()},{onConflict:"user_id,category"});if(g)return E.NextResponse.json({error:"DB Error"},{status:500})}catch(e){return E.NextResponse.json({error:"Database Error",details:e.message},{status:500})}}return E.NextResponse.json({received:!0})}catch(e){return E.NextResponse.json({error:"Internal Server Error",details:e.message},{status:500})}}e.s(["GET",()=>y,"POST",()=>N,"dynamic",0,"force-dynamic"],52915);var A=e.i(52915);let C=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/paddle/webhook/route",pathname:"/api/paddle/webhook",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/Desktop/drivewise/web/app/api/paddle/webhook/route.ts",nextConfigOutput:"",userland:A}),{workAsyncStorage:O,workUnitAsyncStorage:x,serverHooks:P}=C;function I(){return(0,a.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:x})}async function b(e,t,a){C.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let E="/api/paddle/webhook/route";E=E.replace(/\/index$/,"")||"/";let v=await C.prepare(e,t,{srcPage:E,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:S,params:w,nextConfig:y,parsedUrl:N,isDraftMode:A,prerenderManifest:O,routerServerContext:x,isOnDemandRevalidate:P,revalidateOnlyGenerated:I,resolvedPathname:b,clientReferenceManifest:D,serverActionsManifest:T}=v,U=(0,l.normalizeAppPath)(E),k=!!(O.dynamicRoutes[U]||O.routes[b]),j=async()=>((null==x?void 0:x.render404)?await x.render404(e,t,N,!1):t.end("This page could not be found"),null);if(k&&!A){let e=!!O.routes[b],t=O.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await j();throw new R.NoFallbackError}}let L=null;!k||C.isDev||A||(L="/index"===(L=b)?"/":L);let H=!0===C.isDev||!k,M=k&&!H;T&&D&&(0,i.setReferenceManifestsSingleton)({page:E,clientReferenceManifest:D,serverActionsManifest:T,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:T})});let q=e.method||"GET",B=(0,n.getTracer)(),K=B.getActiveScopeSpan(),$={params:w,prerenderManifest:O,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>C.onRequestError(e,t,a,x)},sharedContext:{buildId:S}},F=new d.NodeNextRequest(e),W=new d.NodeNextResponse(t),V=u.NextRequestAdapter.fromNodeNextRequest(F,(0,u.signalFromNodeResponse)(t));try{let i=async e=>C.handle(V,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=B.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${q} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${E}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var n,l;let d=async({previousCacheEntry:r})=>{try{if(!o&&P&&I&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(s);e.fetchMetrics=$.renderOpts.fetchMetrics;let l=$.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=$.renderOpts.collectedTags;if(!k)return await (0,h.sendResponse)(F,W,n,$.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[m.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,a=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:P})},x),t}},u=await C.handleResponse({req:e,nextConfig:y,cacheKey:L,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:O,isRoutePPREnabled:!1,isOnDemandRevalidate:P,revalidateOnlyGenerated:I,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:o});if(!k)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",P?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,_.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&k||c.delete(m.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,f.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(F,W,new Response(u.value.body,{headers:c,status:u.value.status||200})),null};K?await l(K):await B.withPropagatedContext(e.headers,()=>B.trace(c.BaseServerSpan.handleRequest,{spanName:`${q} ${E}`,kind:n.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},l))}catch(t){if(t instanceof R.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:P})}),k)throw t;return await (0,h.sendResponse)(F,W,new Response(null,{status:500})),null}}e.s(["handler",()=>b,"patchFetch",()=>I,"routeModule",()=>C,"serverHooks",()=>P,"workAsyncStorage",()=>O,"workUnitAsyncStorage",()=>x],73651)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__43048cc7._.js.map